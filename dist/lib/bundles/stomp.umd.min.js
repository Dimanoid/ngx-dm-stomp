!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs")):"function"==typeof define&&define.amd?define("@dimanoid/stomp",["exports","rxjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).stomp={},t.rxjs)}(this,(function(t,e){"use strict";var n,i="\n",s="\0",r="1.1",o="1.2",a="1.1,1.0",c=function(){function t(t,e,n){this.command=t,this.headers=null!=e?e:{},this.body=null!=n?n:""}return t.marshall=function(e,n,i){return new t(e,n,i).toString()+s},t.unmarshall=function(e){for(var n=e.split(RegExp(""+s+i+"*")),r=[],o=0;o<n.length;o++){var a=n[o];a&&a.length>0&&r.push(t.unmarshallSingle(a))}return r},t.unmarshallSingle=function(e){for(var n=e.search(RegExp(""+i+i)),r=e.substring(0,n).split(i),o=r.shift(),a={},c=function(t){return t.replace(/^\s+|\s+$/g,"")},h=r.reverse(),u=0;u<h.length;u++){var l=h[u],f=l.indexOf(":");a[c(l.substring(0,f))]=c(l.substring(f+1))}var d="",p=n+2;if(a["content-length"]){var g=parseInt(a["content-length"],0);d=(""+e).substring(p,p+g)}else for(var b=null,m=(u=p,p),v=e.length;(p<=v?m<v:m>v)&&(b=e.charAt(u))!==s;u=p<=v?++m:--m)d+=b;return new t(o,a,d)},t.prototype.toString=function(){var t=[this.command],e=!this.headers["content-length"];e&&delete this.headers["content-length"];for(var n=0,s=Object.keys(this.headers);n<s.length;n++){var r=s[n];t.push(r+":"+this.headers[r])}return this.body&&!e&&t.push("content-length:"+this.sizeOfUTF8(this.body)),t.push(i+this.body),t.join(i)},t.prototype.sizeOfUTF8=function(t){if(t){var e=encodeURI(t).match(/%..|./g);return e?e.length:0}return 0},t}(),h=function(){function t(t){this.counter=0,this.connected=!1,this.heartbeat={outgoing:1e4,incoming:1e4},this.maxWebSocketFrameSize=16384,this.subscriptions={},this.headers={},this.serverActivity=0,this.ws=t,this.ws.binaryType="arraybuffer"}return t.prototype.D=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.debug&&this.debug.apply(this,t)},t.prototype.now=function(){return Date.now?Date.now():(new Date).valueOf()},t.prototype._transmit=function(t,e,n){var i=c.marshall(t,e,n);for(this.D(">>> ",i);;){if(!(i.length>this.maxWebSocketFrameSize))return this.ws.send(i);this.ws.send(i.substring(0,this.maxWebSocketFrameSize)),i=i.substring(this.maxWebSocketFrameSize),this.D("remaining = ",i.length)}},t.prototype._setupHeartbeat=function(t){var e=this;if(t.version===r||t.version===o){var n=t["heart-beat"].split(","),s=n[0],a=n[1];if(0!==this.heartbeat.outgoing&&0!=+a){var c=Math.max(this.heartbeat.outgoing,+a);this.D("send PING every ",c,"ms"),this.pinger=setInterval((function(){e.ws.send(i),e.D(">>> PING")}),c)}if(0!==this.heartbeat.incoming&&0!=+s){var h=Math.max(this.heartbeat.incoming,+s);this.D("check PONG every ",h,"ms"),this.ponger=setInterval((function(){var t=e.now()-e.serverActivity;t>2*h&&(e.D("did not receive server activity for the last",t,"ms"),e.ws.close())}),h)}}},t.prototype.connect=function(t,e,n){var s=this;this.headers.login=t,this.headers.passcode=e,this.headers.host=n,this.D("Opening Web Socket..."),this.ws.onmessage=function(t){var e;if("undefined"!=typeof ArrayBuffer&&t.data instanceof ArrayBuffer){var n=new Uint8Array(t.data);s.D("--- got data length:",n.length),e="";for(var r=0;r<n.length;r++)e+=String.fromCharCode(n[r])}else e=t.data;if(s.serverActivity=s.now(),e!==i){s.D("<<< "+e);var o=c.unmarshall(e),a=function(t){var e=o[t];switch(e.command){case"CONNECTED":s.D("connected to server ",e.headers.server),s.connected=!0,s._setupHeartbeat(e.headers),s.connectCallback&&s.connectCallback(e);break;case"MESSAGE":var n=e.headers.subscription,i=s.subscriptions[n]||s.onreceive;if(i){var r=e.headers["message-id"];e.ack=function(t){null==t&&(t={}),s.ack(r,n,t)},e.nack=function(t){return null==t&&(t={}),s.nack(r,n,t)},i(e)}else s.D("Unhandled received MESSAGE:",e);break;case"RECEIPT":s.onreceipt&&s.onreceipt(e);break;case"ERROR":s.D("ws.readyState:",s.ws.readyState),s.errorCallback&&(s.errorCallback(e),s.D("after errorCallback ws.readyState:",s.ws.readyState));break;default:s.D("Unhandled frame:",e)}s.D("after switch ws.readyState:",s.ws.readyState)};for(r=0;r<o.length;r++)a(r);s.D("after for ws.readyState:",s.ws.readyState)}else s.D("<<< PONG")},this.ws.onclose=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];s.D("ws.onclose, ws.readyState:",s.ws.readyState,t),s._cleanUp(),s.disconnectCallback&&s.disconnectCallback()},this.ws.onopen=function(){s.D("Web Socket Opened..."),s.headers["accept-version"]=a,s.headers["heart-beat"]=[s.heartbeat.outgoing,s.heartbeat.incoming].join(","),s._transmit("CONNECT",s.headers)}},t.prototype.disconnect=function(t,e){this.D("disconnect, ws.readyState:",this.ws.readyState),this._transmit("DISCONNECT",e||{}),this.ws.onclose=null,this.ws.close(),this._cleanUp(),t&&t()},t.prototype._cleanUp=function(){if(this.connected=!1,this.pinger&&clearInterval(this.pinger),this.ponger)return clearInterval(this.ponger)},t.prototype.send=function(t,e,n){return null==e&&(e={}),null==n&&(n=""),e.destination=t,this._transmit("SEND",e,n)},t.prototype.subscribe=function(t,e,n){var i=this;return null==n&&(n={}),n.id||(n.id="sub-"+this.counter++),n.destination=t,this.subscriptions[n.id]=e,this._transmit("SUBSCRIBE",n),{id:n.id,unsubscribe:function(){return i.unsubscribe(n.id)}}},t.prototype.unsubscribe=function(t){delete this.subscriptions[t],this._transmit("UNSUBSCRIBE",{id:t})},t.prototype.begin=function(t){var e=this,n=t||"tx-"+this.counter++;return this._transmit("BEGIN",{transaction:n}),{id:n,commit:function(){return e.commit(n)},abort:function(){return e.abort(n)}}},t.prototype.commit=function(t){return this._transmit("COMMIT",{transaction:t})},t.prototype.abort=function(t){this._transmit("ABORT",{transaction:t})},t.prototype.ack=function(t,e,n){return null==n&&(n={}),n["message-id"]=t,n.subscription=e,this._transmit("ACK",n)},t.prototype.nack=function(t,e,n){return null==n&&(n={}),n["message-id"]=t,n.subscription=e,this._transmit("NACK",n)},t}();t.DmStompState=void 0,(n=t.DmStompState||(t.DmStompState={}))[n.Undefined=0]="Undefined",n[n.Connecting=1]="Connecting",n[n.Connected=2]="Connected",n[n.Disconnecting=3]="Disconnecting",n[n.Disconnected=4]="Disconnected";var u=function(){this.url="",this.login="guest",this.passcode="guest",this.heartbeatIn=0,this.heartbeatOut=2e4,this.host="/",this.protocols=["v10.stomp","v11.stomp"]},l=function(){function t(){}return t.client=function(t,e){null==e&&(e=["v10.stomp","v11.stomp"]);var n=new WebSocket(t,e);return new h(n)},t.over=function(t){return new h(t)},t.D=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.debug&&this.debug.apply(this,t)},t}(),f=function(){function n(n){this.config=n,this._state=t.DmStompState.Undefined,this.state=new e.BehaviorSubject(t.DmStompState.Undefined),this.onError=new e.Subject,this.onConnect=new e.Subject,this.onDisconnect=new e.Subject,this.onReceive=new e.Subject,this.onReceipt=new e.Subject,this.debug=new e.Subject,n&&this.configure(n)}return n.prototype.configure=function(t){var e=this;this.config=t;var n=this.config.ws||new WebSocket(this.config.url,this.config.protocols);this.client=new h(n),this.client.heartbeat.incoming=this.config.heartbeatIn,this.client.heartbeat.outgoing=this.config.heartbeatOut,this.client.errorCallback=function(t){return e.onError.next(t)},this.client.connectCallback=function(t){return e.onConnect.next(t)},this.client.disconnectCallback=function(t){return e.onDisconnect.next(t)},this.client.onreceive=function(t){return e.onReceive.next(t)},this.client.onreceipt=function(t){return e.onReceipt.next(t)}},n.prototype.connect=function(){return!(this._state!=t.DmStompState.Undefined&&this._state!=t.DmStompState.Disconnected||!this.client||!this.config)&&(this.state.next(t.DmStompState.Connecting),this.client.connect(this.config.login,this.config.passcode,this.config.host),!0)},n.prototype.disconnect=function(e){var n=this;this.state.next(t.DmStompState.Disconnecting),this.client.disconnect((function(){return n.state.next(t.DmStompState.Disconnected)}),e)},n.prototype.publish=function(t,e,n){this.client.send(t,n||{},e)},n.prototype.subscribe=function(t,e,n){this.client.subscribe(t,(function(t){return e(t)}),n||{ack:"auto"})},n.prototype.isConnected=function(){return!!this.client&&this.client.connected},n}();t.DmStompService=f,t.DmStompServiceConfig=u,t.StompClient=h,t.StompFrame=c,t.StompQ=l,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=stomp.umd.min.js.map